\documentclass[dvipdfmx]{jsarticle}
\usepackage{graphicx}
\usepackage{amsmath}
\title{公衆無線LANを用いたHTTPS通信に対する\\MITM攻撃の新手法の開発とその実装}
\author{神戸大学工学部電気電子工学科 木村圭一朗}
\begin{document}
    \maketitle
    \begin{abstract}
        \ 昨今のネットワークの著しい普及により，屋外で利用できるネットワークの需要が拡大している．\
        その需要に応える通信インフラとして公衆無線LANがあり，公共のあらゆる場でその整備が進んでいる．\
        しかし，セキュリティ面での懸念は以前として残っている．\
        利用した公衆無線LANが通信の傍受を目的とした悪性のものである可能性は，その懸念の一例である．
        屋外で手軽にインターネットを利用できる反面，ユーザーたちはその公衆無線LANの提供元を確認することはほとんどないだろう．\
        近年は通信内容が暗号化されたhttps通信が主流になり，中間者攻撃も簡単に実行できないが，公衆無線LANを利用した通信の場合はそれが可能になる場合がある．\
        本稿では，主にその手法と具体的な検証結果について記す．
        \newline
    \end{abstract}
    \tableofcontents
    \clearpage
    \section{動機}

    \section{前提知識・用語}
    本稿を進めるにあたり，必要であると思われる前提知識及び用語を以下に記す．
    \subsection{通信関連について}
    \begin{description}
        \item[HTTP]\mbox{}\\
        \item[HTTPS]\mbox{}\\
        \item[サーバ]\mbox{}\\ 
        \item[中間者攻撃（man-in-the-middle attack）]\mbox{}\\ 
    \end{description}
    \subsection{無線LAN関連について}
    \begin{description}
        \item [SSID]\mbox{}\\
            Service Set Identifierの略で，無線LANの識別子を指す．
        \item [Captive Portal]\mbox{}\\
            無線及び有線ネットワークに接続したユーザーが，ネットワークへのアクセスを許可される前に表示されるWebページを指す．\
            ユーザーは，アクセス許可に必要な情報の入力或いは利用規約への同意を行い，その認証を行ってもらう事でインターネットへのアクセスが可能になる．
    \end{description}
    \subsection{その他}
    \begin{description}
        \item[HTML]\mbox{}\\
        \item[ハイパーリンク]\mbox{}\\  
    \end{description}
    \section{目標}
    本研究の目標を以下に示す．
    \begin{quote}
        偽のSSIDを用いた公衆無線LANからクライアントと正規サーバとの通信に割り込み，デバイスに警告を出さずに通信の傍受・改竄を行う事．\
    \end{quote}
    デバイスに警告を出さないという点について，ここではHTTPS通信を想定する．\
    通常，ユーザーが利用するブラウザでは，その通信先が正規のもの，つまり第三者が複製した偽物のサイトではないことを確認する為に，名前検証を行う．\
    名前検証とは，通信のドメインとSSL証明書に記載されているドメインが一致しているかの確認を行う事であるが，この時用いられるSSL証明書を第三者が複製・改竄することは非常に困難とされている．\
    （ここからなんて書こう．．．）
    \section{前提条件と仮説}
    \subsection{前提条件}
    今回，MITM攻撃を仕掛けるにあたり以下の前提条件を設ける．\\
    \\
    被害者は
    \begin{itemize}
        \item 偽SSIDを有する無線LANアクセスポイント（以下，AP）を使用する．
        \item https通信で任意のサイトを閲覧する．
        \item 通信先を確認しない．
    \end{itemize}
    \subsection{仮説}
    上記の前提条件をもとに，次の仮説を立てる．
    \begin{quote}
        ユーザーが攻撃者が用意した偽のSSIDを有する公衆無線LANを用い，そのCaptive Portal画面で表示された偽の検索エンジンからネットを利用した場合，\
        ユーザーの通信がhttps通信でも，攻撃者がその通信の盗聴・改竄が可能になる．
    \end{quote}
    \section{検証内容}
    \subsection{検証対象}
    MITM攻撃が可能か否かの検証にあたり，昨今急激な普及が見られるインターネット通販サイトを対象とした．その中でも国内ECモールの売上ランキング上位2つを占める「楽天」と「Amazon」を対象とした．
    \subsection{検証フロー}
    具体的な検証フローは次の通り．
    \begin{enumerate}
        \item CaptivePortalを検知させて，予め攻撃者が用意しておいたCaptive Portalサイトに誘導させる．
        \item Captive Portalサイトで表示された偽の検索エンジンから，被害者が検索したワードを攻撃者サーバで取得する．
        \item 攻撃者は取得したワードをバックエンドで検索し，その検索結果を取得．
        \item 取得したHTMLファイル内にあるハイパーリンクを書き換え，そのコピーを被害者に提示する．
        \item 以後，クリックしたURLを攻撃者サーバで取得する．
        \item 攻撃者は取得したURLを利用して正規サーバにアクセスする．
        \item 正規サーバから返却されたHTMLファイル内のハイパーリンクを書き換えたものを被害者に提示する．
    \end{enumerate}
    \subsection{実装}
    攻撃者サーバの実装はGolangで実装した．以下に該当のGitHubリポジトリとデモサイトのリンクを載せている．
    \subsubsection{3について}
    ここでは，最も利用されている検索エンジンGoogleを用いた．Googleでの検索結果を取得する為には，検索クエリを作成する必要がある．基本的に任意のクエリ(query)に対して https://google.com/search?q=queryというURLがGoogleの検索URLとなっているが，クエリに空文字列が存在する場合は，その空文字列を+に置換する必要があることに留意しなければならない．例えば，「神戸大学　工学部」と検索する場合には，そのURLはhttps://google.com/search?q=神戸大学+工学部となる．
    \subsubsection{4,5について}
    取得したHTMLファイル内にあるハイパーリンクがそのままであれば，攻撃者サーバではなく正規サーバとの通信に切り替わってしまう．\
    従って，既存のURLを攻撃者サーバへ通信するように書き換え，且つ既存のURLを正確に抽出する必要がある．\
    これを実現する為には，既存のハイパーリンクをルールに則って書き換える必要がある．\
    具体的に，https://example.comというURLに対して処理を行うことを考える．\
    サーバには予め，URLを受け取る為のエンドポイントを設置する．今回の場合は「/templates」というエンドポイントに対して，「url」というパラメータを受け取るものとする．\
    このエンドポイントに対して適切にURLを飛ばすために，サーバ側で予めhttps://mitm.es3.com/templates?url=https://example.comのように書き換える．\
    その結果，被害者に提示したHTMLファイル内にあるハイパーリンクをクリックすると攻撃者サーバに飛び，且つサーバ側で遷移しようとしたページのリンクを取得できる．
    \subsubsection{6,7について}
    フローの4と5で得た正規URLを用いて，バックエンドで正規サーバとの通信及びHTMLファイルの取得を行う．\
    通常の通信であればHTMLファイルの取得のみでよいが，個人アカウントへのログインを行う際は，そのIDとパスワードを取得し且つ得られた情報と実際に登録されている情報との整合性の確認を行わなければならない．\
    登録情報の整合性に関しては，取得した個人情報を攻撃者が手動で入力・確認を行わず，バックエンドでブラウザのインスタンスを生成して入力・確認を行う．\
    この処理に関して，ChromedpというGolangで実装されているパッケージを用いた．\
    具体的な実装についてはGitHubレポジトリを参照して頂きたい．ここでは，処理の流れを以下に簡単に示す．
    \begin{enumerate}
        \item Chromeインスタンスを生成する．
        \item 指定URLを叩き，JS Pathを指定して該当部分に取得したIDやパスワードを入力する．
        \item 個人情報の入力が完了すれば，同じくログインボタンのJS Pathを指定してログイン処理を行う．
        \item 正規サーバに情報を整合させ，返却されたHTMLファイル内のハイパーリンクを，4と5と同じ要領で書き換えて被害者に返却する．
    \end{enumerate}
    JS Pathの指定に関しては，予め正規サイトのログイン画面を見てから確認・指定をする必要がある．
    \section{検証結果}
    検証結果は以下のようになった．
    \subsection{楽天の場合}

    \subsection{Amazonの場合}

    \section{考察}
    今回の結果から，
    \section{参考文献・サイト}
\end{document}